# Moonwall Migration Progress

## Session: 2026-01-20

### Feature Completed: Replace pnpm with Bun - root package.json workspaces config (PRD Feature 2)

**Changes Made:**
1. Updated root `package.json`:
   - Converted all scripts from `pnpm -r --filter='./packages/**' run <cmd>` to `bun run --filter './packages/*' <cmd>`
   - Replaced `pnpm exec` with `bunx`
   - Replaced `pnpm` config block with `trustedDependencies` array for Bun
   - Added `overrides` for `toml` package (v3.0.0) to resolve GitHub tarball compatibility issue with `@zombienet/utils`

2. Removed `pnpm-workspace.yaml` (Bun uses `workspaces` in package.json directly)

3. Removed `pnpm-lock.yaml` (replaced by `bun.lock`)

**Verification:**
- `bun install` - Successfully installed 2338 packages
- `bun pm ls` - All 5 workspace packages linked correctly (@moonwall/cli, @moonwall/docs, @moonwall/tests, @moonwall/types, @moonwall/util)
- `bun typecheck` - Passes with no errors
- `bun test` - 296 tests pass (some failures expected due to Vitest-specific code like `vi.mock` - converting to Bun test runner is PRD Feature 11-16)

**Notes for Next Developer:**
1. The `cpu-features` native module fails to compile due to missing C++ headers on the system - this is a non-critical optional dependency and doesn't affect functionality
2. There are duplicate @polkadot/* package warnings - these come from transitive dependencies and don't affect functionality
3. The test failures related to `vi.mock` are expected - those tests use Vitest-specific APIs. Converting these is covered in PRD Features 11-16 (Replace Vitest with Bun test runner)
4. Next high-priority feature should be Feature 3 (packages/cli), Feature 4 (packages/util), or Feature 5 (packages/types) to complete the Bun migration across all packages

**Files Changed:**
- `package.json` - Updated scripts for Bun
- `pnpm-workspace.yaml` - Deleted
- `pnpm-lock.yaml` - Deleted
- `bun.lock` - Generated (Bun v1.3+ uses text format instead of binary bun.lockb)
- `plans/prd.json` - Marked Feature 2 as complete

---

### Feature Completed: Replace pnpm with Bun - packages/cli package.json (PRD Feature 3)

**Changes Made:**
1. Updated `packages/cli/package.json`:
   - Removed `pnpm` from `engines` constraint (kept `node >= 20`)
   - Updated `build` script: `pnpm exec rm -rf dist` → `rm -rf dist`, `pnpm generate-types` → `bun run generate-types`
   - Updated `lint`/`lint:fix` scripts: `pnpm biome` → `bunx biome`
   - Updated `typecheck` script: `pnpm exec tsc` → `bunx tsc`
   - Updated `test` script: `vitest run` → `bun test`
   - Updated `prepublish` script: `pnpm run` → `bun run`

**Verification:**
- `bun run build` (in packages/cli) - Successfully generates dist/ with all expected outputs
- `bun typecheck` - Passes with no errors
- `bun test` - 296 tests pass, 12 skip, 19 fail (failures are expected vi.mock incompatibilities - Feature 11-16)

**Notes for Next Developer:**
1. The test script now uses `bun test` which is Bun's native test runner. Tests using `vi.mock` (Vitest-specific API) will fail until Feature 11-16 converts them.
2. Next high-priority features are Feature 4 (packages/util) and Feature 5 (packages/types) to complete Bun migration across all core packages.
3. The `bunx` command is Bun's equivalent of `npx`/`pnpm exec` for running binaries.

**Files Changed:**
- `packages/cli/package.json` - Updated scripts and removed pnpm engine constraint
- `plans/prd.json` - Marked Feature 3 as complete

---

### Feature Completed: Replace pnpm with Bun - packages/util package.json (PRD Feature 4)

**Changes Made:**
1. Updated `packages/util/package.json`:
   - Removed `pnpm` from `engines` constraint (kept `node >= 20`)
   - Updated `build` script: `pnpm exec rm -rf dist` → `rm -rf dist`, `pnpm generate-types` → `bun run generate-types`
   - Updated `lint`/`lint:fix` scripts: `pnpm biome` → `bunx biome`
   - Updated `typecheck` script: `pnpm exec tsc` → `bunx tsc`
   - Updated `prepublish` script: `pnpm run` → `bun run`

**Verification:**
- `bun run build` (in packages/util) - Successfully generates dist/ with tsup, all 19 entry files compile
- `bun typecheck` - Passes with no errors
- `bun test` - 296 tests pass, 12 skip, 19 fail (same as Feature 3 - expected vi.mock incompatibilities)

**Notes for Next Developer:**
1. Feature 5 (packages/types) is the next priority to complete Bun migration across all core packages.
2. The packages/util package has no test script of its own - tests are run from the monorepo root.
3. After packages/types is migrated, Feature 6 (test/) and Feature 7 (root monorepo scripts) can be addressed.
4. The dependency on vitest/@vitest/ui in packages/util will be addressed in Features 11-16 when migrating to Bun test runner.

**Files Changed:**
- `packages/util/package.json` - Updated scripts and removed pnpm engine constraint
- `plans/prd.json` - Marked Feature 4 as complete

---

### Feature Completed: Replace pnpm with Bun - packages/types package.json (PRD Feature 5)

**Changes Made:**
1. Updated `packages/types/package.json`:
   - Updated `build` script: `pnpm run generate-types` → `bun run generate-types`
   - Updated `generate-types` script: `pnpm schema` → `bun run schema`
   - Updated `prepublish` script: `pnpm run build && pnpm run generate-types` → `bun run build && bun run generate-types`
   - Updated `schema` script: `pnpm biome format` → `bunx biome format`
   - Note: No `engines` constraint change needed (already only had `node >= 20`, no pnpm constraint)

**Verification:**
- `bun run build` (in packages/types) - Successfully generates dist/ with tsup (8 entry files: config, context, contracts, eth, foundations, helpers, index, runner)
- `bun run schema` - Successfully generates config_schema.json (30KB) using typescript-json-schema
- `bun typecheck` - Passes with no errors
- `bun test` - 296 tests pass, 12 skip, 19 fail (same baseline as Feature 4 - expected vi.mock incompatibilities)

**Notes for Next Developer:**
1. All core packages (cli, util, types) are now migrated to Bun. The next features can proceed:
   - Feature 6 (test/ package.json) - Update test package scripts
   - Feature 7 (root monorepo scripts) - Already partially done in Feature 2
   - Feature 8 (CI/CD configuration) - Update GitHub workflows
   - Feature 9 (documentation updates) - Update README.md and CLAUDE.md
2. The packages/types package uses `typescript-json-schema` for generating the moonwall.config.json schema, which works correctly with Bun.
3. The vitest dependency in packages/types will be addressed in Features 11-16 when migrating to Bun test runner.

**Files Changed:**
- `packages/types/package.json` - Updated scripts to use bun/bunx instead of pnpm
- `plans/prd.json` - Marked Feature 5 as complete

---

### Feature Completed: Replace pnpm with Bun - test/ package.json (PRD Feature 6)

**Changes Made:**
1. Updated `test/package.json`:
   - Removed `packageManager` field (`pnpm@9.1.4`) - this corepack setting is no longer needed with Bun
   - Updated `test-dev` script: `pnpm moonwall` → `bunx moonwall`
   - Updated `test` script: `pnpm moonwall` → `bunx moonwall`
   - Updated `lint` script: `pnpm biome` → `bunx biome`
   - Updated `lint:fix` script: `pnpm biome` → `bunx biome`
   - Removed explicit `pnpm` devDependency (was `^10.24.0`)

**Verification:**
- `bun install` - Successful (cpu-features optional dep failure expected per Note 1 from Feature 2)
- `bun pm ls` - All 5 workspace packages linked correctly (@moonwall/cli, @moonwall/docs, @moonwall/tests, @moonwall/types, @moonwall/util)
- `bun typecheck` - Passes with no errors
- `bun test` - 296 tests pass, 12 skip, 19 fail (same baseline as Feature 5 - vi.mock incompatibilities)

**Notes for Next Developer:**
1. All package-level pnpm→Bun migrations are now complete (cli, util, types, tests).
2. Next high-priority features are:
   - Feature 7: Root monorepo scripts (partially done in Feature 2, may need verification)
   - Feature 8: CI/CD configuration (GitHub workflows)
   - Feature 9: Documentation updates (README.md, CLAUDE.md)
   - Feature 10: bunfig.toml configuration
3. The `fmt` and `fmt:fix` scripts already used plain `biome` (not pnpm biome) so they were already compatible.
4. The `node_test` and `bun_test` scripts were already compatible (node and bun respectively).

**Files Changed:**
- `test/package.json` - Updated scripts and removed pnpm-related config
- `plans/prd.json` - Marked Feature 6 as complete
