# Moonwall Migration Progress

## Session: 2026-01-20

### Feature Completed: Replace pnpm with Bun - root package.json workspaces config (PRD Feature 2)

**Changes Made:**
1. Updated root `package.json`:
   - Converted all scripts from `pnpm -r --filter='./packages/**' run <cmd>` to `bun run --filter './packages/*' <cmd>`
   - Replaced `pnpm exec` with `bunx`
   - Replaced `pnpm` config block with `trustedDependencies` array for Bun
   - Added `overrides` for `toml` package (v3.0.0) to resolve GitHub tarball compatibility issue with `@zombienet/utils`

2. Removed `pnpm-workspace.yaml` (Bun uses `workspaces` in package.json directly)

3. Removed `pnpm-lock.yaml` (replaced by `bun.lock`)

**Verification:**
- `bun install` - Successfully installed 2338 packages
- `bun pm ls` - All 5 workspace packages linked correctly (@moonwall/cli, @moonwall/docs, @moonwall/tests, @moonwall/types, @moonwall/util)
- `bun typecheck` - Passes with no errors
- `bun test` - 296 tests pass (some failures expected due to Vitest-specific code like `vi.mock` - converting to Bun test runner is PRD Feature 11-16)

**Notes for Next Developer:**
1. The `cpu-features` native module fails to compile due to missing C++ headers on the system - this is a non-critical optional dependency and doesn't affect functionality
2. There are duplicate @polkadot/* package warnings - these come from transitive dependencies and don't affect functionality
3. The test failures related to `vi.mock` are expected - those tests use Vitest-specific APIs. Converting these is covered in PRD Features 11-16 (Replace Vitest with Bun test runner)
4. Next high-priority feature should be Feature 3 (packages/cli), Feature 4 (packages/util), or Feature 5 (packages/types) to complete the Bun migration across all packages

**Files Changed:**
- `package.json` - Updated scripts for Bun
- `pnpm-workspace.yaml` - Deleted
- `pnpm-lock.yaml` - Deleted
- `bun.lock` - Generated (Bun v1.3+ uses text format instead of binary bun.lockb)
- `plans/prd.json` - Marked Feature 2 as complete

---

### Feature Completed: Replace pnpm with Bun - packages/cli package.json (PRD Feature 3)

**Changes Made:**
1. Updated `packages/cli/package.json`:
   - Removed `pnpm` from `engines` constraint (kept `node >= 20`)
   - Updated `build` script: `pnpm exec rm -rf dist` → `rm -rf dist`, `pnpm generate-types` → `bun run generate-types`
   - Updated `lint`/`lint:fix` scripts: `pnpm biome` → `bunx biome`
   - Updated `typecheck` script: `pnpm exec tsc` → `bunx tsc`
   - Updated `test` script: `vitest run` → `bun test`
   - Updated `prepublish` script: `pnpm run` → `bun run`

**Verification:**
- `bun run build` (in packages/cli) - Successfully generates dist/ with all expected outputs
- `bun typecheck` - Passes with no errors
- `bun test` - 296 tests pass, 12 skip, 19 fail (failures are expected vi.mock incompatibilities - Feature 11-16)

**Notes for Next Developer:**
1. The test script now uses `bun test` which is Bun's native test runner. Tests using `vi.mock` (Vitest-specific API) will fail until Feature 11-16 converts them.
2. Next high-priority features are Feature 4 (packages/util) and Feature 5 (packages/types) to complete Bun migration across all core packages.
3. The `bunx` command is Bun's equivalent of `npx`/`pnpm exec` for running binaries.

**Files Changed:**
- `packages/cli/package.json` - Updated scripts and removed pnpm engine constraint
- `plans/prd.json` - Marked Feature 3 as complete

---

### Feature Completed: Replace pnpm with Bun - packages/util package.json (PRD Feature 4)

**Changes Made:**
1. Updated `packages/util/package.json`:
   - Removed `pnpm` from `engines` constraint (kept `node >= 20`)
   - Updated `build` script: `pnpm exec rm -rf dist` → `rm -rf dist`, `pnpm generate-types` → `bun run generate-types`
   - Updated `lint`/`lint:fix` scripts: `pnpm biome` → `bunx biome`
   - Updated `typecheck` script: `pnpm exec tsc` → `bunx tsc`
   - Updated `prepublish` script: `pnpm run` → `bun run`

**Verification:**
- `bun run build` (in packages/util) - Successfully generates dist/ with tsup, all 19 entry files compile
- `bun typecheck` - Passes with no errors
- `bun test` - 296 tests pass, 12 skip, 19 fail (same as Feature 3 - expected vi.mock incompatibilities)

**Notes for Next Developer:**
1. Feature 5 (packages/types) is the next priority to complete Bun migration across all core packages.
2. The packages/util package has no test script of its own - tests are run from the monorepo root.
3. After packages/types is migrated, Feature 6 (test/) and Feature 7 (root monorepo scripts) can be addressed.
4. The dependency on vitest/@vitest/ui in packages/util will be addressed in Features 11-16 when migrating to Bun test runner.

**Files Changed:**
- `packages/util/package.json` - Updated scripts and removed pnpm engine constraint
- `plans/prd.json` - Marked Feature 4 as complete

---

### Feature Completed: Replace pnpm with Bun - packages/types package.json (PRD Feature 5)

**Changes Made:**
1. Updated `packages/types/package.json`:
   - Updated `build` script: `pnpm run generate-types` → `bun run generate-types`
   - Updated `generate-types` script: `pnpm schema` → `bun run schema`
   - Updated `prepublish` script: `pnpm run build && pnpm run generate-types` → `bun run build && bun run generate-types`
   - Updated `schema` script: `pnpm biome format` → `bunx biome format`
   - Note: No `engines` constraint change needed (already only had `node >= 20`, no pnpm constraint)

**Verification:**
- `bun run build` (in packages/types) - Successfully generates dist/ with tsup (8 entry files: config, context, contracts, eth, foundations, helpers, index, runner)
- `bun run schema` - Successfully generates config_schema.json (30KB) using typescript-json-schema
- `bun typecheck` - Passes with no errors
- `bun test` - 296 tests pass, 12 skip, 19 fail (same baseline as Feature 4 - expected vi.mock incompatibilities)

**Notes for Next Developer:**
1. All core packages (cli, util, types) are now migrated to Bun. The next features can proceed:
   - Feature 6 (test/ package.json) - Update test package scripts
   - Feature 7 (root monorepo scripts) - Already partially done in Feature 2
   - Feature 8 (CI/CD configuration) - Update GitHub workflows
   - Feature 9 (documentation updates) - Update README.md and CLAUDE.md
2. The packages/types package uses `typescript-json-schema` for generating the moonwall.config.json schema, which works correctly with Bun.
3. The vitest dependency in packages/types will be addressed in Features 11-16 when migrating to Bun test runner.

**Files Changed:**
- `packages/types/package.json` - Updated scripts to use bun/bunx instead of pnpm
- `plans/prd.json` - Marked Feature 5 as complete

---

### Feature Completed: Replace pnpm with Bun - test/ package.json (PRD Feature 6)

**Changes Made:**
1. Updated `test/package.json`:
   - Removed `packageManager` field (`pnpm@9.1.4`) - this corepack setting is no longer needed with Bun
   - Updated `test-dev` script: `pnpm moonwall` → `bunx moonwall`
   - Updated `test` script: `pnpm moonwall` → `bunx moonwall`
   - Updated `lint` script: `pnpm biome` → `bunx biome`
   - Updated `lint:fix` script: `pnpm biome` → `bunx biome`
   - Removed explicit `pnpm` devDependency (was `^10.24.0`)

**Verification:**
- `bun install` - Successful (cpu-features optional dep failure expected per Note 1 from Feature 2)
- `bun pm ls` - All 5 workspace packages linked correctly (@moonwall/cli, @moonwall/docs, @moonwall/tests, @moonwall/types, @moonwall/util)
- `bun typecheck` - Passes with no errors
- `bun test` - 296 tests pass, 12 skip, 19 fail (same baseline as Feature 5 - vi.mock incompatibilities)

**Notes for Next Developer:**
1. All package-level pnpm→Bun migrations are now complete (cli, util, types, tests).
2. Next high-priority features are:
   - Feature 7: Root monorepo scripts (partially done in Feature 2, may need verification)
   - Feature 8: CI/CD configuration (GitHub workflows)
   - Feature 9: Documentation updates (README.md, CLAUDE.md)
   - Feature 10: bunfig.toml configuration
3. The `fmt` and `fmt:fix` scripts already used plain `biome` (not pnpm biome) so they were already compatible.
4. The `node_test` and `bun_test` scripts were already compatible (node and bun respectively).

**Files Changed:**
- `test/package.json` - Updated scripts and removed pnpm-related config
- `plans/prd.json` - Marked Feature 6 as complete

---

### Feature Completed: Replace pnpm with Bun - root monorepo scripts (PRD Feature 7)

**Status:** Already completed as part of Feature 2, but not marked in PRD.

**Verification Performed:**
1. Reviewed `package.json` - All scripts already use `bun run --filter` instead of `pnpm -r`:
   - `build`: `bun run --filter './packages/*' build`
   - `generate-types`: `bun run --filter './packages/*' generate-types`
   - `fmt`/`fmt:fix`: `biome format` + `bun run --filter`
   - `lint`/`lint:fix`: `bun run --filter './packages/*' lint`
   - `typecheck`: `bun run --filter './packages/*' typecheck`
   - `clean-all`: Uses `rm -rf` and `bun run --filter`
   - `pristine-build`: Uses `bun i` and `bun run`
   - `changeset:release`: Uses `bun changeset publish`
   - `display-reports`: Uses `bunx vite`
   - `start`: Uses `bun run moonwall`
   - `test`: Uses `bun test` and `bun run moonwall`

2. Ran `bun run build` - All 3 packages build successfully:
   - @moonwall/types: 8 entry files, schema generated
   - @moonwall/util: 19 entry files
   - @moonwall/cli: Full build with tsc

3. Ran `bun typecheck` - Passes with no errors

4. Ran `bun test` - 296 pass, 12 skip, 19 fail (expected vi.mock incompatibilities - Feature 11-16)

**Notes for Next Developer:**
1. Feature 7 was actually completed during Feature 2 but wasn't marked in the PRD - now marked as complete.
2. Next high-priority features are:
   - Feature 8: CI/CD configuration (GitHub workflows)
   - Feature 9: Documentation updates (README.md, CLAUDE.md)
   - Feature 10: bunfig.toml configuration
3. The test failures are all related to Vitest-specific APIs (vi.mock, importOriginal) and will be addressed in Features 11-16.

**Files Changed:**
- `plans/prd.json` - Marked Feature 7 as complete with notes

---

### Feature Completed: Replace pnpm with Bun - CI/CD configuration (PRD Feature 8)

**Changes Made:**
1. Updated `.github/workflows/main.yml`:
   - Replaced `pnpm/action-setup@v4` with `oven-sh/setup-bun@v2` in all 12 jobs
   - Removed `cache: "pnpm"` from `actions/setup-node@v4` (bun handles its own caching)
   - Replaced all `pnpm install` with `bun install`
   - Replaced all `pnpm run <cmd>` with `bun run <cmd>`
   - Replaced `pnpm moonwall` and `pnpm test` with `bunx moonwall` and `bun test`
   - Removed duplicate `oven-sh/setup-bun@v1` steps that were previously added after pnpm setup

2. Updated `.github/workflows/publish.yml`:
   - Replaced `pnpm/action-setup@v4` with `oven-sh/setup-bun@v2`
   - Replaced `pnpm install` with `bun install`
   - Replaced `pnpm run build` with `bun run build`
   - Updated changeset commands: `pnpm changeset:version` → `bun changeset:version`, `pnpm changeset:release` → `bun changeset:release`

3. Updated `.github/workflows/manual-publish.yml`:
   - Replaced `pnpm/action-setup@v4` with `oven-sh/setup-bun@v2`
   - Replaced `pnpm install` with `bun install`
   - Replaced `pnpm run build` with `bun run build`

4. Updated `.github/workflows/deploy.yml`:
   - Replaced `pnpm/action-setup@v4` with `oven-sh/setup-bun@v2`
   - Replaced `pnpm i` with `bun install`
   - Replaced `pnpm docs:build` with `bun run docs:build`

5. `claude.yml` - No changes needed (doesn't use any package manager commands)

**Verification:**
- `bun typecheck` - Passes with no errors
- `bun test` - 296 pass, 12 skip, 19 fail (same baseline as Feature 7 - vi.mock incompatibilities)

**Notes for Next Developer:**
1. All CI/CD workflows now use Bun exclusively. The workflows should run correctly once pushed.
2. Upgraded from `oven-sh/setup-bun@v1` to `oven-sh/setup-bun@v2` for the latest features and fixes.
3. Removed the pnpm cache configuration since Bun manages its own dependency cache.
4. Node.js is still installed (v23) for compatibility with packages that require Node APIs.
5. Next high-priority features are:
   - Feature 9: Documentation updates (README.md, CLAUDE.md)
   - Feature 10: bunfig.toml configuration
   - Features 11-16: Replace Vitest with Bun test runner (to fix the 19 failing tests)

**Files Changed:**
- `.github/workflows/main.yml` - Updated all jobs to use bun
- `.github/workflows/publish.yml` - Updated to use bun
- `.github/workflows/manual-publish.yml` - Updated to use bun
- `.github/workflows/deploy.yml` - Updated to use bun
- `plans/prd.json` - Marked Feature 8 as complete

---

### Feature Completed: Replace pnpm with Bun - documentation updates (PRD Feature 9)

**Changes Made:**

1. Updated `README.md`:
   - Changed installation command from `pnpm -g i` to `bun add -g`
   - Updated local installation instructions to use `bun i`, `bun run build`, `bun run start`
   - Changed CLI usage examples from `pnpm moonwall` to `bunx moonwall`
   - Updated link from pnpm docs to Bun docs

2. Updated `CLAUDE.md`:
   - Changed monorepo description from "pnpm workspaces" to "Bun workspaces"
   - Updated all installation/build/test commands to use bun
   - Changed "PNPM Workspaces" to "Bun Workspaces" in Key Technologies
   - Changed "Vitest" to "Bun Test Runner" in Key Technologies
   - Updated testing flow description

3. Updated `docs/README.md`:
   - Changed `pnpm docs:dev` to `bun run docs:dev`
   - Changed `pnpm docs:build` and `pnpm docs:preview` to `bun run` equivalents

4. Updated `docs/guide/intro/getting-started.md`:
   - Changed prerequisites from pNPM to Bun (with note about alternatives)
   - Reordered code-group examples to show bun first
   - Updated all `pnpm moonwall` commands to `bunx moonwall`
   - Changed global install example to `bun add -g`

5. Updated `docs/guide/cmd/cli.md`:
   - Changed `pnpm moonwall` to `bunx moonwall`

6. Updated `docs/guide/cmd/init.md`:
   - Changed `pnpm moonwall init` to `bunx moonwall init`

7. Updated `docs/guide/cmd/download.md`:
   - Changed `pnpm moonwall download` examples to `bunx moonwall download`

8. Updated `docs/guide/test/quick-start.md`:
   - Changed `pnpm moonwall` to `bunx moonwall`

9. Updated `docs/guide/test/debug.md`:
   - Changed `pnpm moonwall` commands to `bunx moonwall`
   - Changed "Vitest configuration" to "Bun test configuration"

10. Updated `docs/guide/troubleshooting/faq.md`:
    - Changed `pnpm update` to `bun update`
    - Added note about alternative package managers

11. Updated `TROUBLESHOOTING.md`:
    - Changed `pnpm link` references to `bun link`
    - Updated installation commands to use bun
    - Changed `pnpm moonwall` to `bunx moonwall`
    - Changed "Vitest Configuration" to "Test Configuration"

12. Updated CLI source files with user-facing messages:
    - `packages/cli/src/internal/fileCheckers.ts:58` - Changed `pnpm moonwall download` to `bunx moonwall download`
    - `packages/cli/src/internal/launcherCommon.ts:155` - Changed `pnpm tsx` to `bunx tsx`
    - `packages/cli/src/internal/cmdFunctions/initialisation.ts:87` - Changed `pnpm moonwall test` to `bunx moonwall test`
    - `packages/cli/src/cmds/entrypoint.ts:163` - Changed to package-manager agnostic `moonwall --help`

**Verification:**
- `bun typecheck` - Passes with no errors
- `bun test` - 296 pass, 12 skip, 19 fail (same baseline as Feature 8 - vi.mock incompatibilities)

**Notes for Next Developer:**
1. All pnpm→Bun documentation updates are now complete. The codebase is now fully documented for Bun usage.
2. Next high-priority features are:
   - Feature 10: bunfig.toml configuration
   - Features 11-16: Replace Vitest with Bun test runner (to fix the 19 failing tests)
3. Some doc files still mention Vitest in context descriptions (e.g., debug.md logger names). These will be fully updated when Features 11-16 are completed.
4. The CLI source files were updated to ensure users see consistent "bunx moonwall" messaging.

**Files Changed:**
- `README.md` - Updated installation and usage instructions
- `CLAUDE.md` - Updated all commands and architecture description
- `docs/README.md` - Updated dev/build commands
- `docs/guide/intro/getting-started.md` - Updated prerequisites and commands
- `docs/guide/cmd/cli.md` - Updated CLI invocation
- `docs/guide/cmd/init.md` - Updated init command
- `docs/guide/cmd/download.md` - Updated download examples
- `docs/guide/test/quick-start.md` - Updated test running instructions
- `docs/guide/test/debug.md` - Updated debug commands and descriptions
- `docs/guide/troubleshooting/faq.md` - Updated upgrade instructions
- `TROUBLESHOOTING.md` - Updated development workflow instructions
- `packages/cli/src/internal/fileCheckers.ts` - Updated download command
- `packages/cli/src/internal/launcherCommon.ts` - Updated tsx invocation
- `packages/cli/src/internal/cmdFunctions/initialisation.ts` - Updated success message
- `packages/cli/src/cmds/entrypoint.ts` - Updated help message
- `plans/prd.json` - Marked Feature 9 as complete

---

### Feature Completed: Create bunfig.toml configuration (PRD Feature 10)

**Changes Made:**
1. Created `bunfig.toml` in project root with:
   - `[install]` section:
     - `exact = true` - Use exact versions for reproducible builds
     - `optional = true` - Allow optional native modules to fail gracefully (e.g., cpu-features)
   - `[test]` section:
     - `root = "."` - Test discovery from monorepo root
     - `coverage = true` - Enable coverage reporting by default
     - `coverageThreshold = { lines = 0.8, functions = 0.8, statements = 0.8 }` - 80% target
     - `coverageReporter = ["text", "lcov"]` - Console output + lcov for CI
     - `coverageDir = "./coverage"` - Coverage output directory
     - `coverageSkipTestFiles = true` - Exclude test files from coverage
     - `coveragePathIgnorePatterns` - Exclude node_modules, dist, test files
     - `timeout = 30000` - 30 second timeout for Effect-based async tests

**Verification:**
- `bun typecheck` - Passes with no errors
- `bun test` - 296 pass, 12 skip, 19 fail, 8 errors (same baseline as Feature 9)
- Coverage reports now generated with text table and lcov output
- Current coverage: ~31% functions, ~50% lines (will improve after Features 11-16)

**Notes for Next Developer:**
1. The coverage threshold is set to 80% but currently not enforced (below threshold). This will be addressed when Features 11-16 migrate Vitest to Bun test runner.
2. The 19 test failures and 8 errors are all from `vi.mock`/`importOriginal` (Vitest-specific APIs) in:
   - ProcessManagerService.test.ts
   - ChopsticksService.test.ts
   - launchChopsticksEffect.test.ts
   - FileLock.test.ts
3. The @polkadot/* package warnings about multiple versions are from transitive dependencies and don't affect functionality.
4. Next high-priority features are:
   - Feature 11: Remove vitest dependencies
   - Feature 12: Convert CLI internal tests to bun:test
   - Features 13-16: Update VitestOptionsBuilder, CLI exports, describeSuite, config schema

**Files Changed:**
- `bunfig.toml` - Created with install and test configuration
- `plans/prd.json` - Marked Feature 10 as complete
