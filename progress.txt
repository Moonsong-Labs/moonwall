# Moonwall Migration Progress

## Session: 2026-01-20

### Feature Completed: Replace pnpm with Bun - root package.json workspaces config (PRD Feature 2)

**Changes Made:**
1. Updated root `package.json`:
   - Converted all scripts from `pnpm -r --filter='./packages/**' run <cmd>` to `bun run --filter './packages/*' <cmd>`
   - Replaced `pnpm exec` with `bunx`
   - Replaced `pnpm` config block with `trustedDependencies` array for Bun
   - Added `overrides` for `toml` package (v3.0.0) to resolve GitHub tarball compatibility issue with `@zombienet/utils`

2. Removed `pnpm-workspace.yaml` (Bun uses `workspaces` in package.json directly)

3. Removed `pnpm-lock.yaml` (replaced by `bun.lock`)

**Verification:**
- `bun install` - Successfully installed 2338 packages
- `bun pm ls` - All 5 workspace packages linked correctly (@moonwall/cli, @moonwall/docs, @moonwall/tests, @moonwall/types, @moonwall/util)
- `bun typecheck` - Passes with no errors
- `bun test` - 296 tests pass (some failures expected due to Vitest-specific code like `vi.mock` - converting to Bun test runner is PRD Feature 11-16)

**Notes for Next Developer:**
1. The `cpu-features` native module fails to compile due to missing C++ headers on the system - this is a non-critical optional dependency and doesn't affect functionality
2. There are duplicate @polkadot/* package warnings - these come from transitive dependencies and don't affect functionality
3. The test failures related to `vi.mock` are expected - those tests use Vitest-specific APIs. Converting these is covered in PRD Features 11-16 (Replace Vitest with Bun test runner)
4. Next high-priority feature should be Feature 3 (packages/cli), Feature 4 (packages/util), or Feature 5 (packages/types) to complete the Bun migration across all packages

**Files Changed:**
- `package.json` - Updated scripts for Bun
- `pnpm-workspace.yaml` - Deleted
- `pnpm-lock.yaml` - Deleted
- `bun.lock` - Generated (Bun v1.3+ uses text format instead of binary bun.lockb)
- `plans/prd.json` - Marked Feature 2 as complete

---

### Feature Completed: Replace pnpm with Bun - packages/cli package.json (PRD Feature 3)

**Changes Made:**
1. Updated `packages/cli/package.json`:
   - Removed `pnpm` from `engines` constraint (kept `node >= 20`)
   - Updated `build` script: `pnpm exec rm -rf dist` → `rm -rf dist`, `pnpm generate-types` → `bun run generate-types`
   - Updated `lint`/`lint:fix` scripts: `pnpm biome` → `bunx biome`
   - Updated `typecheck` script: `pnpm exec tsc` → `bunx tsc`
   - Updated `test` script: `vitest run` → `bun test`
   - Updated `prepublish` script: `pnpm run` → `bun run`

**Verification:**
- `bun run build` (in packages/cli) - Successfully generates dist/ with all expected outputs
- `bun typecheck` - Passes with no errors
- `bun test` - 296 tests pass, 12 skip, 19 fail (failures are expected vi.mock incompatibilities - Feature 11-16)

**Notes for Next Developer:**
1. The test script now uses `bun test` which is Bun's native test runner. Tests using `vi.mock` (Vitest-specific API) will fail until Feature 11-16 converts them.
2. Next high-priority features are Feature 4 (packages/util) and Feature 5 (packages/types) to complete Bun migration across all core packages.
3. The `bunx` command is Bun's equivalent of `npx`/`pnpm exec` for running binaries.

**Files Changed:**
- `packages/cli/package.json` - Updated scripts and removed pnpm engine constraint
- `plans/prd.json` - Marked Feature 3 as complete

---

### Feature Completed: Replace pnpm with Bun - packages/util package.json (PRD Feature 4)

**Changes Made:**
1. Updated `packages/util/package.json`:
   - Removed `pnpm` from `engines` constraint (kept `node >= 20`)
   - Updated `build` script: `pnpm exec rm -rf dist` → `rm -rf dist`, `pnpm generate-types` → `bun run generate-types`
   - Updated `lint`/`lint:fix` scripts: `pnpm biome` → `bunx biome`
   - Updated `typecheck` script: `pnpm exec tsc` → `bunx tsc`
   - Updated `prepublish` script: `pnpm run` → `bun run`

**Verification:**
- `bun run build` (in packages/util) - Successfully generates dist/ with tsup, all 19 entry files compile
- `bun typecheck` - Passes with no errors
- `bun test` - 296 tests pass, 12 skip, 19 fail (same as Feature 3 - expected vi.mock incompatibilities)

**Notes for Next Developer:**
1. Feature 5 (packages/types) is the next priority to complete Bun migration across all core packages.
2. The packages/util package has no test script of its own - tests are run from the monorepo root.
3. After packages/types is migrated, Feature 6 (test/) and Feature 7 (root monorepo scripts) can be addressed.
4. The dependency on vitest/@vitest/ui in packages/util will be addressed in Features 11-16 when migrating to Bun test runner.

**Files Changed:**
- `packages/util/package.json` - Updated scripts and removed pnpm engine constraint
- `plans/prd.json` - Marked Feature 4 as complete

---

### Feature Completed: Replace pnpm with Bun - packages/types package.json (PRD Feature 5)

**Changes Made:**
1. Updated `packages/types/package.json`:
   - Updated `build` script: `pnpm run generate-types` → `bun run generate-types`
   - Updated `generate-types` script: `pnpm schema` → `bun run schema`
   - Updated `prepublish` script: `pnpm run build && pnpm run generate-types` → `bun run build && bun run generate-types`
   - Updated `schema` script: `pnpm biome format` → `bunx biome format`
   - Note: No `engines` constraint change needed (already only had `node >= 20`, no pnpm constraint)

**Verification:**
- `bun run build` (in packages/types) - Successfully generates dist/ with tsup (8 entry files: config, context, contracts, eth, foundations, helpers, index, runner)
- `bun run schema` - Successfully generates config_schema.json (30KB) using typescript-json-schema
- `bun typecheck` - Passes with no errors
- `bun test` - 296 tests pass, 12 skip, 19 fail (same baseline as Feature 4 - expected vi.mock incompatibilities)

**Notes for Next Developer:**
1. All core packages (cli, util, types) are now migrated to Bun. The next features can proceed:
   - Feature 6 (test/ package.json) - Update test package scripts
   - Feature 7 (root monorepo scripts) - Already partially done in Feature 2
   - Feature 8 (CI/CD configuration) - Update GitHub workflows
   - Feature 9 (documentation updates) - Update README.md and CLAUDE.md
2. The packages/types package uses `typescript-json-schema` for generating the moonwall.config.json schema, which works correctly with Bun.
3. The vitest dependency in packages/types will be addressed in Features 11-16 when migrating to Bun test runner.

**Files Changed:**
- `packages/types/package.json` - Updated scripts to use bun/bunx instead of pnpm
- `plans/prd.json` - Marked Feature 5 as complete

---

### Feature Completed: Replace pnpm with Bun - test/ package.json (PRD Feature 6)

**Changes Made:**
1. Updated `test/package.json`:
   - Removed `packageManager` field (`pnpm@9.1.4`) - this corepack setting is no longer needed with Bun
   - Updated `test-dev` script: `pnpm moonwall` → `bunx moonwall`
   - Updated `test` script: `pnpm moonwall` → `bunx moonwall`
   - Updated `lint` script: `pnpm biome` → `bunx biome`
   - Updated `lint:fix` script: `pnpm biome` → `bunx biome`
   - Removed explicit `pnpm` devDependency (was `^10.24.0`)

**Verification:**
- `bun install` - Successful (cpu-features optional dep failure expected per Note 1 from Feature 2)
- `bun pm ls` - All 5 workspace packages linked correctly (@moonwall/cli, @moonwall/docs, @moonwall/tests, @moonwall/types, @moonwall/util)
- `bun typecheck` - Passes with no errors
- `bun test` - 296 tests pass, 12 skip, 19 fail (same baseline as Feature 5 - vi.mock incompatibilities)

**Notes for Next Developer:**
1. All package-level pnpm→Bun migrations are now complete (cli, util, types, tests).
2. Next high-priority features are:
   - Feature 7: Root monorepo scripts (partially done in Feature 2, may need verification)
   - Feature 8: CI/CD configuration (GitHub workflows)
   - Feature 9: Documentation updates (README.md, CLAUDE.md)
   - Feature 10: bunfig.toml configuration
3. The `fmt` and `fmt:fix` scripts already used plain `biome` (not pnpm biome) so they were already compatible.
4. The `node_test` and `bun_test` scripts were already compatible (node and bun respectively).

**Files Changed:**
- `test/package.json` - Updated scripts and removed pnpm-related config
- `plans/prd.json` - Marked Feature 6 as complete

---

### Feature Completed: Replace pnpm with Bun - root monorepo scripts (PRD Feature 7)

**Status:** Already completed as part of Feature 2, but not marked in PRD.

**Verification Performed:**
1. Reviewed `package.json` - All scripts already use `bun run --filter` instead of `pnpm -r`:
   - `build`: `bun run --filter './packages/*' build`
   - `generate-types`: `bun run --filter './packages/*' generate-types`
   - `fmt`/`fmt:fix`: `biome format` + `bun run --filter`
   - `lint`/`lint:fix`: `bun run --filter './packages/*' lint`
   - `typecheck`: `bun run --filter './packages/*' typecheck`
   - `clean-all`: Uses `rm -rf` and `bun run --filter`
   - `pristine-build`: Uses `bun i` and `bun run`
   - `changeset:release`: Uses `bun changeset publish`
   - `display-reports`: Uses `bunx vite`
   - `start`: Uses `bun run moonwall`
   - `test`: Uses `bun test` and `bun run moonwall`

2. Ran `bun run build` - All 3 packages build successfully:
   - @moonwall/types: 8 entry files, schema generated
   - @moonwall/util: 19 entry files
   - @moonwall/cli: Full build with tsc

3. Ran `bun typecheck` - Passes with no errors

4. Ran `bun test` - 296 pass, 12 skip, 19 fail (expected vi.mock incompatibilities - Feature 11-16)

**Notes for Next Developer:**
1. Feature 7 was actually completed during Feature 2 but wasn't marked in the PRD - now marked as complete.
2. Next high-priority features are:
   - Feature 8: CI/CD configuration (GitHub workflows)
   - Feature 9: Documentation updates (README.md, CLAUDE.md)
   - Feature 10: bunfig.toml configuration
3. The test failures are all related to Vitest-specific APIs (vi.mock, importOriginal) and will be addressed in Features 11-16.

**Files Changed:**
- `plans/prd.json` - Marked Feature 7 as complete with notes

---

### Feature Completed: Replace pnpm with Bun - CI/CD configuration (PRD Feature 8)

**Changes Made:**
1. Updated `.github/workflows/main.yml`:
   - Replaced `pnpm/action-setup@v4` with `oven-sh/setup-bun@v2` in all 12 jobs
   - Removed `cache: "pnpm"` from `actions/setup-node@v4` (bun handles its own caching)
   - Replaced all `pnpm install` with `bun install`
   - Replaced all `pnpm run <cmd>` with `bun run <cmd>`
   - Replaced `pnpm moonwall` and `pnpm test` with `bunx moonwall` and `bun test`
   - Removed duplicate `oven-sh/setup-bun@v1` steps that were previously added after pnpm setup

2. Updated `.github/workflows/publish.yml`:
   - Replaced `pnpm/action-setup@v4` with `oven-sh/setup-bun@v2`
   - Replaced `pnpm install` with `bun install`
   - Replaced `pnpm run build` with `bun run build`
   - Updated changeset commands: `pnpm changeset:version` → `bun changeset:version`, `pnpm changeset:release` → `bun changeset:release`

3. Updated `.github/workflows/manual-publish.yml`:
   - Replaced `pnpm/action-setup@v4` with `oven-sh/setup-bun@v2`
   - Replaced `pnpm install` with `bun install`
   - Replaced `pnpm run build` with `bun run build`

4. Updated `.github/workflows/deploy.yml`:
   - Replaced `pnpm/action-setup@v4` with `oven-sh/setup-bun@v2`
   - Replaced `pnpm i` with `bun install`
   - Replaced `pnpm docs:build` with `bun run docs:build`

5. `claude.yml` - No changes needed (doesn't use any package manager commands)

**Verification:**
- `bun typecheck` - Passes with no errors
- `bun test` - 296 pass, 12 skip, 19 fail (same baseline as Feature 7 - vi.mock incompatibilities)

**Notes for Next Developer:**
1. All CI/CD workflows now use Bun exclusively. The workflows should run correctly once pushed.
2. Upgraded from `oven-sh/setup-bun@v1` to `oven-sh/setup-bun@v2` for the latest features and fixes.
3. Removed the pnpm cache configuration since Bun manages its own dependency cache.
4. Node.js is still installed (v23) for compatibility with packages that require Node APIs.
5. Next high-priority features are:
   - Feature 9: Documentation updates (README.md, CLAUDE.md)
   - Feature 10: bunfig.toml configuration
   - Features 11-16: Replace Vitest with Bun test runner (to fix the 19 failing tests)

**Files Changed:**
- `.github/workflows/main.yml` - Updated all jobs to use bun
- `.github/workflows/publish.yml` - Updated to use bun
- `.github/workflows/manual-publish.yml` - Updated to use bun
- `.github/workflows/deploy.yml` - Updated to use bun
- `plans/prd.json` - Marked Feature 8 as complete

---

### Feature Completed: Replace pnpm with Bun - documentation updates (PRD Feature 9)

**Changes Made:**

1. Updated `README.md`:
   - Changed installation command from `pnpm -g i` to `bun add -g`
   - Updated local installation instructions to use `bun i`, `bun run build`, `bun run start`
   - Changed CLI usage examples from `pnpm moonwall` to `bunx moonwall`
   - Updated link from pnpm docs to Bun docs

2. Updated `CLAUDE.md`:
   - Changed monorepo description from "pnpm workspaces" to "Bun workspaces"
   - Updated all installation/build/test commands to use bun
   - Changed "PNPM Workspaces" to "Bun Workspaces" in Key Technologies
   - Changed "Vitest" to "Bun Test Runner" in Key Technologies
   - Updated testing flow description

3. Updated `docs/README.md`:
   - Changed `pnpm docs:dev` to `bun run docs:dev`
   - Changed `pnpm docs:build` and `pnpm docs:preview` to `bun run` equivalents

4. Updated `docs/guide/intro/getting-started.md`:
   - Changed prerequisites from pNPM to Bun (with note about alternatives)
   - Reordered code-group examples to show bun first
   - Updated all `pnpm moonwall` commands to `bunx moonwall`
   - Changed global install example to `bun add -g`

5. Updated `docs/guide/cmd/cli.md`:
   - Changed `pnpm moonwall` to `bunx moonwall`

6. Updated `docs/guide/cmd/init.md`:
   - Changed `pnpm moonwall init` to `bunx moonwall init`

7. Updated `docs/guide/cmd/download.md`:
   - Changed `pnpm moonwall download` examples to `bunx moonwall download`

8. Updated `docs/guide/test/quick-start.md`:
   - Changed `pnpm moonwall` to `bunx moonwall`

9. Updated `docs/guide/test/debug.md`:
   - Changed `pnpm moonwall` commands to `bunx moonwall`
   - Changed "Vitest configuration" to "Bun test configuration"

10. Updated `docs/guide/troubleshooting/faq.md`:
    - Changed `pnpm update` to `bun update`
    - Added note about alternative package managers

11. Updated `TROUBLESHOOTING.md`:
    - Changed `pnpm link` references to `bun link`
    - Updated installation commands to use bun
    - Changed `pnpm moonwall` to `bunx moonwall`
    - Changed "Vitest Configuration" to "Test Configuration"

12. Updated CLI source files with user-facing messages:
    - `packages/cli/src/internal/fileCheckers.ts:58` - Changed `pnpm moonwall download` to `bunx moonwall download`
    - `packages/cli/src/internal/launcherCommon.ts:155` - Changed `pnpm tsx` to `bunx tsx`
    - `packages/cli/src/internal/cmdFunctions/initialisation.ts:87` - Changed `pnpm moonwall test` to `bunx moonwall test`
    - `packages/cli/src/cmds/entrypoint.ts:163` - Changed to package-manager agnostic `moonwall --help`

**Verification:**
- `bun typecheck` - Passes with no errors
- `bun test` - 296 pass, 12 skip, 19 fail (same baseline as Feature 8 - vi.mock incompatibilities)

**Notes for Next Developer:**
1. All pnpm→Bun documentation updates are now complete. The codebase is now fully documented for Bun usage.
2. Next high-priority features are:
   - Feature 10: bunfig.toml configuration
   - Features 11-16: Replace Vitest with Bun test runner (to fix the 19 failing tests)
3. Some doc files still mention Vitest in context descriptions (e.g., debug.md logger names). These will be fully updated when Features 11-16 are completed.
4. The CLI source files were updated to ensure users see consistent "bunx moonwall" messaging.

**Files Changed:**
- `README.md` - Updated installation and usage instructions
- `CLAUDE.md` - Updated all commands and architecture description
- `docs/README.md` - Updated dev/build commands
- `docs/guide/intro/getting-started.md` - Updated prerequisites and commands
- `docs/guide/cmd/cli.md` - Updated CLI invocation
- `docs/guide/cmd/init.md` - Updated init command
- `docs/guide/cmd/download.md` - Updated download examples
- `docs/guide/test/quick-start.md` - Updated test running instructions
- `docs/guide/test/debug.md` - Updated debug commands and descriptions
- `docs/guide/troubleshooting/faq.md` - Updated upgrade instructions
- `TROUBLESHOOTING.md` - Updated development workflow instructions
- `packages/cli/src/internal/fileCheckers.ts` - Updated download command
- `packages/cli/src/internal/launcherCommon.ts` - Updated tsx invocation
- `packages/cli/src/internal/cmdFunctions/initialisation.ts` - Updated success message
- `packages/cli/src/cmds/entrypoint.ts` - Updated help message
- `plans/prd.json` - Marked Feature 9 as complete

---

### Feature Completed: Create bunfig.toml configuration (PRD Feature 10)

**Changes Made:**
1. Created `bunfig.toml` in project root with:
   - `[install]` section:
     - `exact = true` - Use exact versions for reproducible builds
     - `optional = true` - Allow optional native modules to fail gracefully (e.g., cpu-features)
   - `[test]` section:
     - `root = "."` - Test discovery from monorepo root
     - `coverage = true` - Enable coverage reporting by default
     - `coverageThreshold = { lines = 0.8, functions = 0.8, statements = 0.8 }` - 80% target
     - `coverageReporter = ["text", "lcov"]` - Console output + lcov for CI
     - `coverageDir = "./coverage"` - Coverage output directory
     - `coverageSkipTestFiles = true` - Exclude test files from coverage
     - `coveragePathIgnorePatterns` - Exclude node_modules, dist, test files
     - `timeout = 30000` - 30 second timeout for Effect-based async tests

**Verification:**
- `bun typecheck` - Passes with no errors
- `bun test` - 296 pass, 12 skip, 19 fail, 8 errors (same baseline as Feature 9)
- Coverage reports now generated with text table and lcov output
- Current coverage: ~31% functions, ~50% lines (will improve after Features 11-16)

**Notes for Next Developer:**
1. The coverage threshold is set to 80% but currently not enforced (below threshold). This will be addressed when Features 11-16 migrate Vitest to Bun test runner.
2. The 19 test failures and 8 errors are all from `vi.mock`/`importOriginal` (Vitest-specific APIs) in:
   - ProcessManagerService.test.ts
   - ChopsticksService.test.ts
   - launchChopsticksEffect.test.ts
   - FileLock.test.ts
3. The @polkadot/* package warnings about multiple versions are from transitive dependencies and don't affect functionality.
4. Next high-priority features are:
   - Feature 11: Remove vitest dependencies
   - Feature 12: Convert CLI internal tests to bun:test
   - Features 13-16: Update VitestOptionsBuilder, CLI exports, describeSuite, config schema

**Files Changed:**
- `bunfig.toml` - Created with install and test configuration
- `plans/prd.json` - Marked Feature 10 as complete

---

### Feature Completed: Replace Vitest with Bun test runner - remove vitest dependencies (PRD Feature 11)

**Changes Made:**
1. Removed vitest dependencies from `packages/util/package.json`:
   - Removed `vitest` (3.2.4) from dependencies
   - Removed `@vitest/ui` (^3.2.4) from dependencies

2. Removed vitest dependencies from `packages/types/package.json`:
   - Removed `vitest` (3.2.4) from dependencies

3. INTENTIONALLY KEPT vitest in `packages/cli/package.json`:
   - `vitest` and `@vitest/ui` remain because `runTests.ts` uses `startVitest` from `vitest/node` to programmatically run tests
   - This is a dependency for moonwall's test orchestration feature (e.g., `moonwall test <env>`)
   - Will be removed when Feature 13 replaces `VitestOptionsBuilder` with `BunTestOptionsBuilder` using `Bun.spawn`

**Verification:**
- `bun install` - Successful (lockfile updated, workspace packages linked correctly)
- `bun typecheck` - Passes with no errors
- `bun test` - 296 pass, 12 skip, 19 fail, 8 errors (same baseline as Feature 10)
- Confirmed vitest no longer in packages/util or packages/types dependencies

**Notes for Next Developer:**
1. packages/types and packages/util never actually imported from vitest - the dependency was vestigial.
2. packages/cli MUST keep vitest until Feature 13 because:
   - `packages/cli/src/cmds/runTests.ts` imports `{ startVitest } from "vitest/node"`
   - `VitestOptionsBuilder` class builds `UserConfig` for vitest
   - The `moonwall test <env>` command spawns vitest programmatically
3. The 19 failing tests + 8 errors are all in `packages/cli/src/internal/effect/__tests__/` and use Vitest-specific APIs:
   - `vi.mock()` - Feature 12 will convert to bun:test's `mock()` module mocking
   - `importOriginal()` - Not available in bun:test, needs alternative approach
4. Next high-priority feature is Feature 12: Convert CLI internal tests to bun:test.
5. Feature 13 is critical - it will remove the last vitest dependency by replacing `startVitest` with `Bun.spawn`.

**Files Changed:**
- `packages/util/package.json` - Removed vitest and @vitest/ui dependencies
- `packages/types/package.json` - Removed vitest dependency
- `bun.lock` - Updated to remove vitest from util/types
- `plans/prd.json` - Marked Feature 11 as complete with notes

---

### Feature Completed: Replace Vitest with Bun test runner - convert CLI internal tests (PRD Feature 12)

**Changes Made:**
1. Converted all 8 test files in `packages/cli/src/internal/effect/__tests__/` from vitest to bun:test:
   - `ChopsticksMultiChain.test.ts` - Changed import from 'vitest' to 'bun:test'
   - `ChopsticksService.test.ts` - Changed import from 'vitest' to 'bun:test'
   - `FileLock.test.ts` - Changed import from 'vitest' to 'bun:test'
   - `launchChopsticksEffect.test.ts` - Changed import from 'vitest' to 'bun:test' (removed unused vi import)
   - `launchNodeEffect.test.ts` - Changed import from 'vitest' to 'bun:test'
   - `NodeReadinessService.test.ts` - Changed import from 'vitest' to 'bun:test'
   - `PortDiscoveryService.test.ts` - Changed import from 'vitest' to 'bun:test'
   - `ProcessManagerService.test.ts` - Complete rewrite to use bun:test module mocking

2. Key migration patterns applied:
   - `vi.mock()` with `importOriginal` → `mock.module()` (bun:test doesn't have importOriginal)
   - `vi.fn()` → `mock()`
   - `vi.clearAllMocks()` → `mockFn.mockClear()` on each mock function
   - `vi.spyOn()` → `spyOn()` (same API in bun:test)

3. Added TypeScript support for bun:test:
   - Added `bun-types@1.3.6` to `packages/cli/package.json` devDependencies
   - Updated `packages/cli/tsconfig.json` to include `"types": ["bun-types"]`

**Verification:**
- `bun test packages/cli/src/internal/effect/__tests__/` - 93 pass, 4 skip, 0 fail
- `bun typecheck` - Passes with no errors
- The 4 skipped tests are integration tests (marked with `describe.skip`) that require real network connections

**Notes for Next Developer:**
1. The previous 19 failing tests + 8 errors were all in the effect/__tests__/ directory using Vitest-specific APIs - now all pass.
2. The `ProcessManagerService.test.ts` required the most significant rewrite because:
   - Vitest's `vi.mock()` with `importOriginal` lets you extend the original module
   - Bun's `mock.module()` replaces the entire module, so you must provide all needed exports
   - Mock functions must be created before `mock.module()` calls, then dynamically imported after
3. Next high-priority feature is Feature 13: Replace VitestOptionsBuilder with BunTestOptionsBuilder
   - This will allow removing the last vitest dependency from packages/cli
   - Requires replacing `startVitest` from 'vitest/node' with `Bun.spawn`
4. The bun-types addition also partially addresses Feature 54 (Update TypeScript configuration for Bun)

**Files Changed:**
- `packages/cli/src/internal/effect/__tests__/ChopsticksMultiChain.test.ts` - vitest → bun:test
- `packages/cli/src/internal/effect/__tests__/ChopsticksService.test.ts` - vitest → bun:test
- `packages/cli/src/internal/effect/__tests__/FileLock.test.ts` - vitest → bun:test
- `packages/cli/src/internal/effect/__tests__/launchChopsticksEffect.test.ts` - vitest → bun:test
- `packages/cli/src/internal/effect/__tests__/launchNodeEffect.test.ts` - vitest → bun:test
- `packages/cli/src/internal/effect/__tests__/NodeReadinessService.test.ts` - vitest → bun:test
- `packages/cli/src/internal/effect/__tests__/PortDiscoveryService.test.ts` - vitest → bun:test
- `packages/cli/src/internal/effect/__tests__/ProcessManagerService.test.ts` - Complete rewrite for bun:test
- `packages/cli/package.json` - Added bun-types devDependency
- `packages/cli/tsconfig.json` - Added types: ['bun-types']
- `bun.lock` - Updated with bun-types
- `plans/prd.json` - Marked Feature 12 as complete

---

### Feature Completed: Replace Vitest with Bun test runner - update VitestOptionsBuilder (PRD Feature 13)

**Changes Made:**
1. Removed vitest imports from `packages/cli/src/cmds/runTests.ts`:
   - Removed `import type { UserConfig, Vitest } from "vitest/node"`
   - Removed `import { startVitest } from "vitest/node"`

2. Created `BunTestOptionsBuilder` class with Bun test CLI flag mapping:
   - `setTimeout(timeout)` → `--timeout=<ms>`
   - `setReporter(reporter)` → `--reporter=junit|dots`
   - `setOutputFile(file)` → `--reporter-outfile=<path>`
   - `setTestNamePattern(pattern)` → `--test-name-pattern=<regex>`
   - `setCoverage(enabled)` → `--coverage`
   - `setMaxConcurrency(threads)` → `--max-concurrency=<n>`
   - `setBail(count)` → `--bail=<n>`
   - `setUpdateSnapshots(update)` → `--update-snapshots`
   - `addPassthroughArgs(args)` → converts object to CLI flags

3. Created `runBunTests()` function that uses `Bun.spawn`:
   - Spawns `bun test` with CLI arguments
   - Captures stdout/stderr via pipe
   - Supports silent mode and streaming output via callback
   - Returns `BunTestResult { success, exitCode, stdout, stderr }`

4. Updated `executeTests()` function:
   - Returns `Promise<BunTestResult>` instead of `Promise<Vitest>`
   - Uses `BunTestOptionsBuilder` instead of `VitestOptionsBuilder`
   - Simplified Promise handling (no longer wraps in `new Promise`)

5. Updated `testCmd()` function:
   - Changed `vitest.state.getFiles().filter(...)` to `result.success` check

6. Updated `testRunArgs` type:
   - Added `silent?: boolean` for suppressing output
   - Added `onOutputLine?: (line: string) => void` for streaming output
   - Deprecated `vitestPassthroughArgs` in favor of `bunTestPassthroughArgs`

7. Updated `LogViewer.tsx` component:
   - Changed from `onConsoleLog` (vitest-specific) to `onOutputLine` callback

8. Updated `packages/cli/package.json` build script:
   - Added `--external bun:test` to mark bun:test as external in tsup build

**Verification:**
- `bun typecheck` - Passes with no errors
- `bun run build` - Successfully builds with bun:test marked as external
- `bun test packages/cli/src/internal/effect/__tests__/` - 93 pass, 4 skip, 0 fail
- Full test suite: 305 pass, 12 skip, 16 fail (failures are unrelated - require moonwall environment)

**Notes for Next Developer:**
1. The vitest dependency is still in packages/cli because `index.ts` and `runnerContext.ts` still export from vitest. These will be updated in:
   - Feature 14: Update CLI exports to use bun:test
   - Feature 15: Update describeSuite wrapper to use bun:test
2. After Features 14-15 are complete, vitest can be fully removed from packages/cli.
3. The 16 failing tests in the full suite are E2E tests under `test/suites/` that require a running moonwall environment and config - not related to this change.
4. The `BunTestResult` type provides a simpler interface than Vitest's state object - just check `success` boolean.

**Files Changed:**
- `packages/cli/src/cmds/runTests.ts` - Complete rewrite: removed vitest imports, added BunTestOptionsBuilder, runBunTests(), updated executeTests() and testCmd()
- `packages/cli/src/cmds/components/LogViewer.tsx` - Updated to use onOutputLine instead of onConsoleLog
- `packages/cli/package.json` - Updated build script with --external bun:test
- `plans/prd.json` - Marked Feature 13 as complete

---

### Feature Completed: Replace Vitest with Bun test runner - update CLI exports (PRD Feature 14)

**Changes Made:**
1. Updated `packages/cli/src/index.ts`:
   - Changed `export { afterAll, afterEach, beforeAll, beforeEach, expect } from "vitest"` to `from "bun:test"`

2. Updated `packages/cli/src/lib/runnerContext.ts`:
   - Changed `import { afterAll, beforeAll, describe, it } from "vitest"` to `from "bun:test"`
   - Fixed `describe.skip()` call to include empty callback function: `describe.skip(name, () => {})`
   - Note: bun:test requires the callback function argument, unlike vitest which accepts just a string

3. Removed vitest dependencies from `packages/cli/package.json`:
   - Removed `vitest` (3.2.4) from dependencies
   - Removed `@vitest/ui` (^3.2.4) from dependencies
   - These are no longer needed since Feature 13 replaced programmatic vitest API with Bun.spawn

**Verification:**
- `bun install` - Successful (cpu-features optional dep failure expected - documented in Feature 2)
- `bun typecheck` - Passes with no errors
- `bun test packages/cli/src/internal/effect/__tests__/` - 93 pass, 4 skip, 0 fail
- `bun test` (full suite) - 305 pass, 12 skip, 16 fail (same baseline as Feature 13 - failures are E2E tests requiring moonwall environment)

**Notes for Next Developer:**
1. Vitest is now completely removed from the entire monorepo! No packages depend on vitest anymore.
2. The bun:test API is mostly compatible with vitest, but `describe.skip(name)` requires a callback function as the second argument whereas vitest allowed just a string.
3. Next high-priority feature is Feature 15: Update describeSuite wrapper to use bun:test
   - This will complete the test runner migration
   - After Feature 15, the codebase will be fully using bun:test
4. Feature 16 (config schema) can then update vitestArgs to bunTestArgs
5. The @polkadot/* package warnings about multiple versions are from transitive dependencies and don't affect functionality.

**Files Changed:**
- `packages/cli/src/index.ts` - Changed vitest exports to bun:test
- `packages/cli/src/lib/runnerContext.ts` - Changed vitest imports to bun:test, fixed describe.skip call
- `packages/cli/package.json` - Removed vitest and @vitest/ui dependencies
- `bun.lock` - Updated to remove vitest packages
- `plans/prd.json` - Marked Feature 14 as complete

---

### Feature Completed: Replace Vitest with Bun test runner - update describeSuite wrapper (PRD Feature 15)

**Changes Made:**
1. Updated `packages/cli/src/lib/runnerContext.ts`:
   - Changed JSDoc comment from "handled by the vitest instance" to "handled by the bun:test runner"
   - Changed comment URL from vitest docs to bun:test docs
   - Note: The actual bun:test imports were already updated in Feature 14

2. Updated `packages/types/src/runner.ts`:
   - Changed `CustomTest` type's test callback from `test: (vitestContext: any) => void` to `test: () => void | Promise<void>`
   - Changed `ITestCase` interface's test callback from `test: (vitestContext: any) => void` to `test: () => void | Promise<void>`
   - These changes reflect bun:test's simpler callback signature (no context parameter)

**Verification:**
- `bun typecheck` - Passes with no errors
- `bun test packages/cli/src/internal/effect/__tests__/` - 93 pass, 4 skip, 0 fail
- `bun test` (full suite) - 305 pass, 12 skip, 16 fail (same baseline as Feature 14 - failures are E2E tests requiring moonwall environment)

**Notes for Next Developer:**
1. Feature 15 completes the describeSuite wrapper migration to bun:test. The core test runner migration is now complete.
2. Next high-priority feature is Feature 16: Update test configuration schema
   - This will rename `vitestArgs` to `bunTestArgs` in the config types
   - Regenerate the config_schema.json
   - Update moonwall.config.json examples
3. The 16 failing tests are all in `test/suites/` and require running moonwall environments (e.g., `moonwall test basic`). They are not related to the test runner migration.
4. After Feature 16, the Vitest→Bun test runner migration will be fully complete.

**Files Changed:**
- `packages/cli/src/lib/runnerContext.ts` - Updated comments to reference bun:test
- `packages/types/src/runner.ts` - Updated CustomTest and ITestCase types for bun:test callback signature
- `plans/prd.json` - Marked Feature 15 as complete

---

### Feature Completed: Replace Vitest with Bun test runner - update test configuration schema (PRD Feature 16)

**Changes Made:**
1. Updated `packages/types/src/config.ts`:
   - Renamed `vitestArgs` → `bunTestArgs` with updated JSDoc referencing Bun test docs
   - Renamed `multiThreads` → `maxConcurrency` with simplified type (`boolean | number` instead of `boolean | number | object`)
   - Renamed `printVitestOptions` → `printTestRunnerOptions`
   - Deprecated `cacheImports` field (Bun handles dependency bundling automatically)

2. Updated `packages/cli/src/cmds/runTests.ts`:
   - Changed `env.multiThreads` → `env.maxConcurrency`
   - Changed `env.vitestArgs` → `env.bunTestArgs`
   - Changed `env.printVitestOptions` → `env.printTestRunnerOptions`

3. Updated `packages/cli/src/internal/cmdFunctions/initialisation.ts`:
   - Changed `multiThreads: false` → `maxConcurrency: false` in the config template

4. Regenerated `packages/types/config_schema.json`:
   - Now reflects new field names: `bunTestArgs`, `maxConcurrency`, `printTestRunnerOptions`
   - Old fields (`vitestArgs`, `multiThreads`, `printVitestOptions`) are no longer in schema

5. Updated `test/moonwall.config.json`:
   - Changed `vitestArgs` → `bunTestArgs`
   - Changed `retry: 4` → `rerun-each: 4` (Bun uses `--rerun-each` flag, not `--retry`)

**Verification:**
- `bun typecheck` - Passes with no errors
- `bun test` - 305 pass, 12 skip, 16 fail (same baseline as Feature 15 - E2E test failures require moonwall environment)

**Notes for Next Developer:**
1. **The Vitest→Bun test runner migration is now COMPLETE!** Features 11-16 have fully migrated the test runner.
2. The old Vitest-related fields are intentionally removed (not deprecated with fallback) since this is a major version change.
3. Next high-priority features are:
   - Feature 17: Effect migration - add Effect to packages/util dependencies
   - Feature 54: Update TypeScript configuration for Bun (partially done - packages/cli has bun-types)
   - Feature 55: Final integration verification
4. The 16 failing tests are E2E tests in `test/suites/` that require running moonwall environments - not related to this change.
5. Breaking change for users: Config files using `vitestArgs`, `multiThreads`, or `printVitestOptions` need to be updated to `bunTestArgs`, `maxConcurrency`, and `printTestRunnerOptions` respectively.

**Files Changed:**
- `packages/types/src/config.ts` - Renamed vitest fields to bun equivalents
- `packages/types/config_schema.json` - Regenerated with new field names
- `packages/cli/src/cmds/runTests.ts` - Updated to use new config field names
- `packages/cli/src/internal/cmdFunctions/initialisation.ts` - Updated config template
- `test/moonwall.config.json` - Updated example to use bunTestArgs
- `plans/prd.json` - Marked Feature 16 as complete

---

### Feature Completed: Effect migration - add Effect to packages/util dependencies (PRD Feature 17)

**Changes Made:**
1. Updated `packages/util/package.json`:
   - Added `effect` ^3.19.8 to dependencies
   - Added `@effect/platform` ^0.93.6 to dependencies
   - Added `bun-types` ^1.3.6 to devDependencies (for bun:test type support)

2. Updated `packages/util/tsconfig.json`:
   - Added `"types": ["bun-types"]` to compilerOptions for bun:test type declarations

3. Created `packages/util/src/__tests__/effect-imports.test.ts`:
   - Test for Effect core module imports (Effect.succeed, Effect.fail, Effect.map, Effect.flatMap)
   - Test for running a simple Effect with Effect.runPromise
   - Test for pipe with Effect combinators
   - Test for @effect/platform FileSystem import

**Verification:**
- `bun install` - Successful (effect@3.19.8 and @effect/platform@0.93.6 installed)
- `bun typecheck` - Passes with no errors
- `bun test packages/util/src/__tests__/` - 4 pass, 0 fail
- `bun test` (full suite) - 309 pass, 12 skip, 16 fail (same E2E failures as Feature 16)

**Notes for Next Developer:**
1. Effect is now available in packages/util for creating Effect-based utility functions.
2. The @effect/platform package provides FileSystem, HttpClient, and other platform services.
3. This also partially addresses Feature 54 (Update TypeScript configuration for Bun) - packages/util now has bun-types configured like packages/cli.
4. Next high-priority features are:
   - Feature 18: Create Effect error types module
   - Feature 19: Create DevFoundationService interface
   - Feature 54: Complete bun-types setup for packages/types
5. The 16 failing tests are E2E tests in `test/suites/` that require running moonwall environments - not related to this change.
6. The @polkadot/* package warnings about multiple versions are from transitive dependencies and don't affect functionality.

**Files Changed:**
- `packages/util/package.json` - Added effect, @effect/platform, and bun-types dependencies
- `packages/util/tsconfig.json` - Added types: ['bun-types']
- `packages/util/src/__tests__/effect-imports.test.ts` - New test file verifying Effect imports
- `bun.lock` - Updated with new dependencies
- `plans/prd.json` - Marked Feature 17 as complete

---

### Feature Completed: Effect migration - create Effect error types module (PRD Feature 18)

**Changes Made:**
1. Created `packages/cli/src/internal/effect/errors/foundation.ts` with 5 tagged error classes:
   - `FoundationStartupError` - For when a foundation (dev, chopsticks, zombie, read_only) fails to start
   - `FoundationShutdownError` - For when a foundation fails to shutdown cleanly
   - `ProviderConnectionError` - For when a blockchain provider (polkadotJs, ethers, viem, web3, papi) fails to connect
   - `FoundationHealthCheckError` - For when a foundation fails health checks
   - `FoundationConfigError` - For invalid foundation configuration

2. Created `packages/cli/src/internal/effect/errors/index.ts`:
   - Exports all error types from foundation.ts
   - Includes documentation about error hierarchy

3. Updated `packages/cli/src/internal/effect/index.ts`:
   - Added export for the new errors subdirectory
   - Added comments distinguishing low-level (process) vs high-level (foundation) errors

**Design Decisions:**
- These are high-level errors that sit above existing low-level errors (ProcessError, NodeLaunchError, PortDiscoveryError)
- Each error has typed fields for context (e.g., `foundationType`, `providerType`, `endpoint`)
- Uses Effect's `Data.TaggedError` pattern for:
  - Discriminated union support via string tags
  - Type-safe error narrowing with `Effect.catchTag`
  - Structural equality for testing
- Errors include optional `cause` field to wrap underlying errors
- Added two additional errors beyond PRD requirements (FoundationHealthCheckError, FoundationConfigError) as they are needed for complete foundation lifecycle management

**Verification:**
- `bun typecheck` - Passes with no errors
- `bun test` - 309 pass, 12 skip, 16 fail, 2 errors (same baseline as Feature 17 - E2E tests require moonwall environment)

**Notes for Next Developer:**
1. Feature 19 (DevFoundationService interface) can now use these error types for its Effect return types.
2. The existing low-level errors in `packages/cli/src/internal/effect/errors.ts` remain unchanged - they will be wrapped by these high-level errors.
3. Example usage pattern:
   ```ts
   Effect.catchTag("FoundationStartupError", (error) => {
     console.error(`${error.foundationType} failed: ${error.message}`);
   })
   ```
4. The error types are now available via `import { FoundationStartupError } from "@moonwall/cli"` after build.

**Files Changed:**
- `packages/cli/src/internal/effect/errors/foundation.ts` - New file with 5 tagged error classes
- `packages/cli/src/internal/effect/errors/index.ts` - New file exporting all error types
- `packages/cli/src/internal/effect/index.ts` - Updated to export from errors subdirectory
- `plans/prd.json` - Marked Feature 18 as complete

---

### Feature Completed: Effect migration - create DevFoundationService interface (PRD Feature 19)

**Changes Made:**
1. Created `packages/cli/src/internal/effect/services/` directory for high-level foundation services

2. Created `packages/cli/src/internal/effect/services/DevFoundationService.ts`:
   - Defined `DevFoundationService` using Effect's `Context.Tag` pattern
   - Interface methods:
     - `start(config)`: Returns `Effect<{info: DevFoundationRunningInfo, stop: Effect<void>}, FoundationStartupError>`
     - `stop()`: Returns `Effect<void, FoundationShutdownError>`
     - `getStatus()`: Returns `Effect<DevFoundationStatus>`
     - `healthCheck()`: Returns `Effect<void, FoundationHealthCheckError>`
   - Defined `DevFoundationConfig` type with fields: `command`, `args`, `name`, `launchSpec`, `isEthereumChain`
   - Defined `DevFoundationStatus` union type: `Starting | Running | Stopped | Failed`
   - Defined `DevFoundationRunningInfo` with: `process`, `rpcPort`, `logPath`, `config`

3. Created `packages/cli/src/internal/effect/services/index.ts`:
   - Exports all types and the service tag from DevFoundationService
   - Documentation about service hierarchy (DevFoundation, Chopsticks, Zombie, ReadOnly)

4. Updated `packages/cli/src/internal/effect/index.ts`:
   - Reorganized exports into logical groups (low-level errors, high-level errors, low-level services, high-level services, launchers)
   - Added export for `./services/index.js`

**Design Decisions:**
- Used `Context.Tag` pattern for dependency injection (testable via `Layer.succeed` mocks)
- Return type of `start()` includes both `info` and a `stop` Effect - this allows the caller to control when cleanup happens (important for test lifecycle)
- Status uses a tagged union (`_tag` discriminator) for type-safe pattern matching
- Added `healthCheck()` method beyond PRD requirements - needed for complete foundation lifecycle management
- Service interface only - implementation (`DevFoundationServiceLive` Layer) is Feature 20

**Verification:**
- `bun typecheck` - Passes with no errors
- `bun test` - 309 pass, 12 skip, 16 fail, 2 errors (same baseline as Feature 18 - E2E tests require moonwall environment)

**Notes for Next Developer:**
1. Feature 20 (DevFoundationService Layer implementation) should use the existing `launchNodeEffect` function and wrap it in a Layer.
2. The service pattern established here should be followed for other foundation services (Chopsticks, Zombie, ReadOnly).
3. The `DevFoundationConfig` derives from `DevLaunchSpec` in `@moonwall/types` - the transformation happens in the caller.
4. Example usage pattern:
   ```ts
   Effect.gen(function* () {
     const devFoundation = yield* DevFoundationService;
     const { info, stop } = yield* devFoundation.start(config);
     // Use the node...
     yield* stop; // Manual cleanup
   });
   ```

**Files Changed:**
- `packages/cli/src/internal/effect/services/DevFoundationService.ts` - New service interface file
- `packages/cli/src/internal/effect/services/index.ts` - New index file for services
- `packages/cli/src/internal/effect/index.ts` - Updated to export from services/
- `plans/prd.json` - Marked Feature 19 as complete

---

### Feature Completed: Effect migration - implement DevFoundationService Layer (PRD Feature 20)

**Changes Made:**
1. Created `packages/cli/src/internal/effect/services/DevFoundationServiceLive.ts`:
   - Implemented `DevFoundationServiceLive` Layer using `Layer.effect` pattern
   - Uses `Ref` from Effect for mutable state tracking (status, runningInfo, cleanup)
   - Composes lower-level services: `ProcessManagerService`, `RpcPortDiscoveryService`, `NodeReadinessService`

2. Implemented all service methods:
   - `start(config)`: Spawns node process, discovers RPC port, returns `{info, stop}` tuple
   - `stop()`: Executes stored cleanup Effect, updates state to Stopped
   - `getStatus()`: Returns current `DevFoundationStatus` (Starting|Running|Stopped|Failed)
   - `healthCheck()`: Uses `NodeReadinessService` for WebSocket-based RPC validation

3. Created `makeDevFoundationServiceLayer()` factory function:
   - Allows injection of custom dependencies for testing
   - Enables mocking lower-level services with `Layer.succeed`

4. Updated `packages/cli/src/internal/effect/services/index.ts`:
   - Added exports for `DevFoundationServiceLive` and `makeDevFoundationServiceLayer`

5. Created comprehensive unit test suite:
   - `packages/cli/src/internal/effect/__tests__/services/DevFoundationService.test.ts`
   - 9 tests covering: start success, start failures (process launch, port discovery), stop, getStatus, healthCheck
   - Uses `Layer.succeed` pattern for mocking dependencies
   - All tests pass

**Design Decisions:**
- Used `Ref<DevFoundationState>` for state management - allows tracking status, process info, and cleanup across method calls
- Composed lower-level services directly instead of wrapping `launchNodeEffect` - cleaner Effect composition
- Health check uses shorter timeout (10 attempts × 50ms) vs startup (600 attempts × 200ms)
- Both `start()` return value's `stop` Effect and the service's `stop()` method work correctly
- Error mapping converts low-level errors (ProcessError, PortDiscoveryError) to high-level foundation errors

**Verification:**
- `bun typecheck` - Passes with no errors
- `bun test packages/cli/src/internal/effect/__tests__/services/` - 9 pass, 0 fail
- `bun test` (full suite) - 318 pass (up from 309), 12 skip, 16 fail, 2 errors (same E2E baseline)

**Notes for Next Developer:**
1. Feature 20 completes the DevFoundationService implementation. The service is now usable via:
   ```ts
   import { Effect } from "effect";
   import { DevFoundationService, DevFoundationServiceLive } from "@moonwall/cli";

   const program = Effect.gen(function* () {
     const devFoundation = yield* DevFoundationService;
     const { info, stop } = yield* devFoundation.start(config);
     console.log(`Node running on port ${info.rpcPort}`);
     yield* stop;
   }).pipe(Effect.provide(DevFoundationServiceLive));
   ```
2. Next features to implement:
   - Feature 21: ChopsticksFoundationService interface
   - Feature 22: ChopsticksFoundationService Layer implementation
   - Feature 23: ZombieFoundationService interface
3. The `makeDevFoundationServiceLayer()` factory is useful for integration tests that need partial mocking.
4. The 16 failing tests are E2E tests in `test/suites/` requiring moonwall environment - not related to this change.

**Files Changed:**
- `packages/cli/src/internal/effect/services/DevFoundationServiceLive.ts` - New Layer implementation
- `packages/cli/src/internal/effect/services/index.ts` - Added exports for Live Layer
- `packages/cli/src/internal/effect/__tests__/services/DevFoundationService.test.ts` - New test file (9 tests)
- `plans/prd.json` - Marked Feature 20 as complete

---

### Feature Completed: Effect migration - create ChopsticksFoundationService interface (PRD Feature 21)

**Changes Made:**
1. Created `packages/cli/src/internal/effect/services/ChopsticksFoundationService.ts`:
   - Defined `ChopsticksFoundationService` using Effect's `Context.Tag` pattern
   - Interface methods:
     - `start(config)`: Returns `Effect<{info: ChopsticksFoundationRunningInfo, stop: Effect<void>}, FoundationStartupError>`
     - `stop()`: Returns `Effect<void, FoundationShutdownError>`
     - `getStatus()`: Returns `Effect<ChopsticksFoundationStatus>`
     - `healthCheck()`: Returns `Effect<void, FoundationHealthCheckError>`
     - `createBlock(params?)`: Returns `Effect<BlockCreationResult, ChopsticksBlockError>`
     - `setStorage(params)`: Returns `Effect<void, ChopsticksStorageError>`
     - `getBlock(hashOrNumber?)`: Returns `Effect<{hash, number} | undefined, ChopsticksBlockError>`
     - `setHead(hashOrNumber)`: Returns `Effect<void, ChopsticksBlockError>`
   - Defined `ChopsticksFoundationConfig` type with fields: configPath, name, launchSpec, wsPort, type, wasmOverride, buildBlockMode, newBlockTimeout
   - Defined `ChopsticksFoundationStatus` union type: `Starting | Running | Stopped | Failed`
   - Defined `ChopsticksFoundationRunningInfo` with: wsPort, endpoint, logPath, config

2. Updated `packages/cli/src/internal/effect/services/index.ts`:
   - Added exports for ChopsticksFoundationService and all related types
   - Updated service hierarchy comments

**Design Decisions:**
- Re-uses existing `ChopsticksBlockError` and `ChopsticksStorageError` from `ChopsticksService.ts` for method-level errors
- Uses high-level foundation errors (`FoundationStartupError`, `FoundationShutdownError`, `FoundationHealthCheckError`) for lifecycle operations - consistent with DevFoundationService
- Follows same pattern as DevFoundationService: `start()` returns `{info, stop}` tuple for manual cleanup control
- Added chopsticks-specific methods (`createBlock`, `setStorage`, `getBlock`, `setHead`) that DevFoundationService doesn't have
- Status type includes `endpoint` field instead of `rpcPort` since chopsticks exposes a WebSocket URL

**Verification:**
- `bun typecheck` - Passes with no errors
- `bun test` - 318 pass, 12 skip, 16 fail, 2 errors (same baseline as Feature 20 - failures are E2E tests requiring moonwall environment)

**Notes for Next Developer:**
1. Feature 22 (ChopsticksFoundationService Layer implementation) should:
   - Use `Layer.effect` or `Layer.scoped` pattern (like DevFoundationServiceLive)
   - Integrate with existing `launchChopsticksEffect` function for spawning
   - Compose with `ChopsticksService` for createBlock/setStorage/getBlock/setHead operations
   - Use `Ref` for state management (status, runningInfo, cleanup)
2. The existing `ChopsticksService` in `ChopsticksService.ts` is a low-level service exposing the Blockchain instance directly. The new `ChopsticksFoundationService` is a high-level lifecycle wrapper.
3. Multi-chain XCM scenarios (relay + parachains) may need separate handling - the current interface is for single-chain mode. Feature 22 notes should address this.
4. The 16 failing tests are E2E tests in `test/suites/` requiring moonwall environment - not related to this change.

**Files Changed:**
- `packages/cli/src/internal/effect/services/ChopsticksFoundationService.ts` - New service interface file
- `packages/cli/src/internal/effect/services/index.ts` - Added exports for ChopsticksFoundationService types
- `plans/prd.json` - Marked Feature 21 as complete

